<% pipeline_prefix = branch_name.gsub('/', '-') %>
- name: <%= pipeline_prefix %>-build-test-deploy
  plan:
  - get: <%= pipeline_prefix %>-git-src
    trigger: true

  
  - put: <%= branch_name %>-repo-status
    params: { state: pending, commit: <%= pipeline_prefix %>-git-src }

  - task: build-and-test
    privileged: true
    file: <%= pipeline_prefix %>-git-src/ci/tasks/build-and-test.yml
    input_mapping: {git-src: <%= pipeline_prefix %>-git-src}
    on_failure:
	  do:
	    - put: <%= branch_name %>-repo-status
		  params: { state: error, commit: <%= pipeline_prefix %>-git-src }
  
  - put: <%= branch_name %>-repo-status
    params: { state: success, commit: <%= pipeline_prefix %>-git-src }